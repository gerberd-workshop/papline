# Overall description of PAPline

## Introduction

PAPline is an abbreviation for "Performing Archaeogenetic Pipeline", it can be downloaded from [here](www.github.com/gerberd-workshop/papline) and used freely under Debian based Linux distributions. This pipeline was written in bash and is supplemented by scripts written in R and python v3.8.10 programming languages. The program aims to analyse raw sequencing data and perform read alignment, apply various data filtering methods, and finally provide summary tables about the run with additional haplogroup assessments, genetic sex determinations, aneuploidies, etc. The concept of 'PAPline' is highly similar to the [Paleomix](https://paleomix.readthedocs.io/en/stable/) and the [EAGER](https://eager.readthedocs.io/en/latest/) softwares, however, we aimed to create a program that needs only a few adjustments before actual application, and is also user friendly. Regular updates are planned for PAPline in the future by releasing new versions every second year.

## Dependencies & prerequisites

The following tools and softwares are required for PAPline:

+---------------+-------------------------------------------------------------------+-----------------------+
| **Name**      | **Available from**                                                | **Ubuntu repository** |
+===============+===================================================================+=======================+
| ANGSD         | <http://www.popgen.dk/angsd/index.php/ANGSD>                      |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| bamtools      | <https://github.com/pezmaster31/bamtools>                         | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| bamUtil       | <https://github.com/statgen/bamUtil>                              |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| bedtools      | <https://bedtools.readthedocs.io/en/latest/>                      | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| Bowtie2       | <http://bowtie-bio.sourceforge.net/bowtie2/index.shtml>           | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| BWA           | <https://github.com/lh3/bwa>                                      | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| ContamMix     | contact Philip L.F. Johnson [plfj\@umd.edu](mailto:plfj@umd.edu)  |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| cutadapt      | <https://github.com/marcelm/cutadapt>                             | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| FastQC        | <https://github.com/s-andrews/FastQC>                             | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| Haplogrep2    | <https://github.com/seppinho/haplogrep-cmd>                       |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| Mafft         | <https://mafft.cbrc.jp/alignment/software/>                       | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| MapDamage     | <https://ginolhac.github.io/mapDamage/>                           | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| plink1.9      | <https://www.cog-genomics.org/plink2>                             | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| preseq        | <https://github.com/smithlabcode/preseq>                          |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| samtools      | <https://github.com/samtools/samtools>                            | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| SeqPrep       | <https://github.com/jstjohn/SeqPrep>                              | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| SequenceTools | <https://github.com/stschiff/sequenceTools>                       |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| vcftools      | <https://vcftools.github.io/index.html>                           | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| yLeaf2        | <https://github.com/genid/Yleaf>                                  |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| admixr        | R package at CRAN                                                 |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| admixtools    | R package at <https://github.com/uqrmaie1/admixtools>             |                       |
+---------------+-------------------------------------------------------------------+-----------------------+
| dplyr         | R package at CRAN                                                 | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| ggplot2       | R package at CRAN                                                 | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| ggrepel       | R package at CRAN                                                 | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| seqinr        | R package at CRAN                                                 | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| stringr       | R package at CRAN                                                 | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+
| tibble        | R package at CRAN                                                 | ✔                     |
+---------------+-------------------------------------------------------------------+-----------------------+

Also, be sure that your system is up to date. PAPline was mainly written under Ubuntu 18.04 and 20.04, accordingly system updates are recommended to be not older than 2018 versions.

The following parameters are needed to run the PAPline:

-   parameter file

-   input directory

-   output directory

-   sample list file

The parameter file contains information about the run parameters, it can be created by using text editor or the graphical interface of the PAPline. Input and output directories are straightforwardly can be used, while the sample list file needs special attention. This latter file is a csv file of sample names and inner barcodes (when absent, leave this field empty), where each line represents one sample and the corresponding inner barcode sequence, see example:

| **SampleID** | **P5 barcode** | **P7 barcode** |
|--------------|----------------|----------------|
| S001         | AGTCTAG        | AGATCGA        |
| S002         | GGCCTAG        | TACAGTA        |
| S003         | CCAGATA        | TTACAGA        |

However, **the header must be excluded from the actual csv file** and the first line has to be the first sample! After installing PAPline an example sample list file (named as list.csv) is provided in the folder /xmp. No varying columns are allowed in the csv file to avoid mixing samples with one, two or without barcodes.

## Installation

PAPline does not need to be installed besides, only the above listed softwares are needed to be installed to your PATH. When downloaded, it can be directly run from directory, or can be added to your PATH. Also, you don't need to install all listed softwares to run PAPline, only those that you are going to use inside a session.

## Options

PAPline is available in the CLI version with a graphical interface panel. for creating the parameter file. When starting a PAPline session from the Terminal by typing `papline` the following options should appear:

``` {.console}
-a    Auto mode, provide parameterfile, see README
-h    Print this message
-g    Start GUI version
```

The "auto mode" expects a parameter file, for which an example is available under the /xmp folder in the installed version of the 'PAPline', and besides the GUI panel it can be created manually. The parameter file may contain the following options, \*marked are essential:

+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Name** | **Type**        | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+==========+=================+==========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+
| `*workf` | Multiple choice | Setting up the main workflow:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|          |                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 | `FQ` (fastq) starts the full pipeline and expects a directory where either gzipped or unzipped *fastq* files are present. Paired end (PE) read files must contain **R1** and **R2** in the file names and the file extensions must be either ***fq***, ***fq.gz***, ***fastq*** or ***fastq.gz***. Single end (SE) read files are expected with **no** **R1** or **R2** present in filenames. Also, `FQ` option allows more than 2 *fastq* files per sample, i.e. if a sequencing run resulted in e.g. 3 pairs of *fastq* files per sample then PAPline can process these as a single sample, but correct formatting is needed for this. |
|          |                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 | `BAM` expects bam files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|          |                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 | `PAPLINE` indicates the usage of PAPline library structure, i.e. if a run was started and subfolders are created but for some reason the run was interrupted or need to be rerunned, PAPline continues from the last interrupted step instead of deleting all existing libraries, however, fails when expected files to continue with are missing or were being relocated. It uses a *papli_log* file saved to the `indir` folder, further described below, that lists out finished steps, and can be maintained manually.                                                                                                               |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `*runam` | STR             | The name of the run, if `workf=FQ/BAM` a folder with the same name will be created at the `endir` path, or the `indir` path in case the `endir` is missing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `*indir` | PATH            | Path to the input folder containing *fastq* or *bam* files or the PAPline file structure, according to `workf`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `endir`  | PATH            | Path to the output folder, where directory will be created under a name provided in `runam` when `workf=FQ/BAM`. Existing directories under the same name will be deleted and re-created, except when the `PAPLINE` option is `TRUE`, in which case the `endir` option will be ignored.                                                                                                                                                                                                                                                                                                                                                  |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `*listf` | FILE            | The name of the comma separated (*csv*) file containing samples and corresponding barcodes, without header. Example is given in the /xmp folder. If no barcodes are given, the PAPline automatically skips the `btrim` and the `bdisc` options. When the `workf=BAM` no other columns are considered besides the first with the sample names. No varying columns are allowed in the *csv* to avoid mixing samples with one, two or without barcodes. PAPline can only process a single data type (PE (paired end), SE (single end), barcoded, or non-barcoded) in a single run.                                                          |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `thred`  | INT             | Number of threads used by the PAPline. The default value is `24`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `fstqc`  | TRUE/FALSE      | When `fstgc=TRUE` (default option) the PAPline will perform quality checks on each *fastq* file by using the `FastQC` software.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `bqthr`  | INT             | Base quality (BQ) threshold (PHRED score, Illumina based value range 0-62) to be considered in analyses, default is `30`, if `0`, no BQ check or filtering will be applied during analyses.                                                                                                                                                                                                                                                                                                                                                                                                                                              |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `atrim`  | TRUE/FALSE      | Argument to set if Illumina adapters from the end of the sequencing reads should be trimmed off by the PAPline. The default value is `FALSE`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `p5ada`  | STR             | Defines the P5 adapter sequence when `workf=FQ`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `p7ada`  | STR             | Defines the P7 adapter sequence when `workf=FQ`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `btrim`  | TRUE/FALSE      | When `workf=FQ` and `btrim=TRUE` (default option) the PAPline trims off inner barcodes provided in the *csv* file.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `bdisc`  | TRUE/FALSE      | When `workf=FQ` and `bdisc=TRUE` (default option) the PAPline discards reads lacking a barcode sequence.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `seeds`  | INT             | Sets maximum differences in seed for the `atrim` and the `btrim` options, as well as the `BWA ALN` mapping method. The default value is `2`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `overl`  | INT             | When `workf=FQ` and `overl>0`, paired end (PE) reads will be merged to single fragments and saved to a *fastq* file to create an input for the read mapping. The `overl` INT parameter gives the number of basepairs to overlap between read pairs. The default value is `5`.                                                                                                                                                                                                                                                                                                                                                            |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `minle`  | INT             | When `workf=FQ` `minle` will define the minimum read length of reads to be considered. Shorter reads will be discarded from further analyses. The default value is `15`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `*refer` | FILE            | The name of the reference *fasta* file, which has to be indexed with `samtools` and `BWA`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `befer`  | FILE            | Filename of the `Bowtie2` indexed reference file. When using the `Bowtie2` reference in the graphical interface mode, one has to select one of the indexed reference genome files, and PAPline will automatically trim off the unnecessary tags. When the parameter file is being created manually, the path still has to point to an existing file, i.e. the `Bowtie2` tag must remain or the PAPline will provide an error message regarding the `Bowtie2` indexing error.                                                                                                                                                             |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `align`  | Multiple choice | When `workf=FQ` the alignment method can be selected using this argument. The available methods are: `BWA_Aln`, `BWA_Mem`, `Bowtie2_EVF` (end-to-end very fast), `Bowtie2_EF` (end-to-end fast), `Bowtie2_ES` (end-to-end sensitive), `Bowtie2_EVS` (end-to-end very sensitive), `Bowtie2_LVF` (local very fast), `Bowtie2_LF` (local fast), `Bowtie2_LS` (local sensitive), and `Bowtie2_LVS` (local very sensitive). The default method is `Bowtie2_EVF`. The parameter setted to `runam` will be added as read groups to `Bowtie2` mappings.                                                                                          |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `krbam`  | TRUE/FALSE      | When `krbam=TRUE` the PAPline will keep the initial raw *BAM* files after various filters were applied. The default is `FALSE`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `rmdup`  | TRUE/FALSE      | Remove PCR duplicates from the *BAM* file. The default value is `TRUE`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `mapqt`  | INT             | Mapping quality (MQ) threshold (PHRED score, Illumina based value range 0-62) to be considered in analyses, default is `30`, if `0`, no MQ check or filtering will be applied during analyses.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `mapda`  | TRUE/FALSE      | Run the `MapDamage` software to check damage patterns. The default value is `TRUE`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `cntmx`  | TRUE/FALSE      | Run the `ContaMix` software to assess contamination levels. The default value is `FALSE`. (It is really slow.)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `ctrim`  | INT             | The number of base pairs to be trimmed from both ends of the reads, if `ctrim=0` this step will be skipped. The default value is `2`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `mtfas`  | Multiple choice | Defines the mode for base calling method to create a mitochondrial DNA *fasta* file. The available options are:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 | `Permissive`: At positions where the coverage is equal to the value given by the `mtcov` argument a base is only called when all reads contain the same base. Below this given threshold no bases are called, above this given threshold the majority rule will be applied. This option is default.                                                                                                                                                                                                                                                                                                                                      |
|          |                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 | `Majority rule`: The majority rule is applied to call a base, minimum coverage is given by `mtcov` argument.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|          |                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 | `Random`: Calls the base from a randomly selected read if the position is covered at least by the number given in the `mtcov` argument.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|          |                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|          |                 | `None`: No *fasta* file will be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `mtcov`  | INT             | Coverage threshold for calling a base when creating the mitochondrial DNA *fasta* file. The default value is `2`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `cotrv`  | TRUE/FALSE      | When `cotrv=TRUE` the PAPline calls only transversions for nuclear genome even if the BED file contains transitions as well, and considers only transversions when assigning the Y chromosome haplogroup. The default value is `FALSE`                                                                                                                                                                                                                                                                                                                                                                                                   |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `psudo`  | TRUE/FALSE      | When `psudo=TRUE` the PAPline calls pseudohaploid genome. The default value is `TRUE`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `disis`  | INT             | Indicates the variant quality for calling SNPs of clinical significance. It is similarly calculated as the BQ or MQ, i.e. `bqthr=10` equals to `disis=10`. Also, only heterozygous calls are made when `disis>0` (the default value is `30`). `disis=0` indicates skipping this step.                                                                                                                                                                                                                                                                                                                                                    |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `pigme`  | INT             | Indicates the variant quality for calling SNP-s of pigmentation. It is similarly calculated as the BQ or MQ, i.e. `bqthr=10` equals to `pigme=10`. Also, only heterozygous calls are made when `pigme>0` (the default value is `4`). `pigme=0` indicates skipping this step.                                                                                                                                                                                                                                                                                                                                                             |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `glqua`  | INT             | Defines the genotype likelihood quality. It is similarly calculated as `pigme` quality. The default value is `1`. `glqua=0` indicates skipping this step, only when `psudo=FALSE`                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `eigen`  | TRUE/FALSE      | When `eigen=TRUE` the PAPline calls the genotypes and transforms data into EIGENSTRAT format. The default value is `FALSE`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| `plink`  | TRUE/FALSE      | When `plink=TRUE` the PAPline calls genotypes and transforms data into PLINK format. The default value is `FALSE`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
+----------+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

The graphical interface version opens a panel where all of the options listed above can be adjusted and saved.

## Library structure of the PAPline

The `endir` option creates a working directory. Under this working directory subdirectories of samples will be created. Besides, PAPline places the final report file and the individual result files here. The final report file contains all the information most frequently needed for an ancient NGS data analysis, *e.g.* number of reads entered the pipeline, number of reads mapped, average genomic coverage, mitochondrial DNA haplogroup, *etc*. This report file is formatted in a supplementary-ready format, thus exhaustive manual labour can be saved. Also, the *papli_log* file is placed here which contains information about the run, i.e. each line represent run step tags marked as true or false, *e.g.*:

``` {.console}
fstqc_run=T
bqtrm_run=T
atrim_run=F
...
```

This *papli_log* file enables the user to take full control over workflow steps, when the `papli=TRUE`. It switches on and off workflow steps, i.e. all steps set to be `F` will be processed, whereas steps set to be `T` or missing from list will be skipped. However, when `workf=PAPLINE` `fastqc_run` and `bqtrim_run` logs files will be ignored because the input for these are raw *bam* files from outside of the PAPline library structure.

\
In the sample folders a number of files and other sub-folders can be found, each one contains various files produced by steps of the workflow, *e.g.* *ALNFILES* folder contains the finalised *bam* file(s), *etc*. Files in the sample folder consist of a number of files, *e.g.* results of `MapDamage` run, or the results of coverage calculations.

## Running PAPline

Finally, when everything is set, 'PAPline' can be run by using the following command:

`./papline -a /path/to/parameterfile`

The running time depends on the hardware, the size of the input files, and the workflow settings. If the parameter file contains discrepancies, the program shuts down and asks for revision. Eigenstrat and PLINK formatted *bed* and SNP files can be found under the /references folder. The pre-formatted *bed* files used for the pigmentation and disease essays are located in the same folder. These files can be modified if needed. Besides the basic default pre-formatted *bed* files contain the dbSNP IDs, the positions of the hg19 chromosomes, the reference and alternate allele, as well as the phenotype of the variants, which data table can be extended or modified at will by new data, except headers.

## Formatting requirements

Since PAPline offers multiple input processing, certain requirements are needed when naming the input files. First, when analysing paired end (PE) reads, each *fastq* file **must contain r1/R1 and r2/R2 in their names** to distinguish p5 and p7 pairs. Second, when more than two pairs of *fastq* files exist per sample, the correct filename should look like the following:

`SAMPLEID_someinfo_otherinfo_PAIRID_someinfo_R1/2_someinfo.fastq`

Where the *SAMPLEID* is the ID of the sample, *someinfo* and *otherinfo* can be anything while *PAIRID* also can be anything but these have to be unique for the pair of *fastq* files. When the filenames are correct the PAPline can do the pairing of the files. Parts of the file name, like *SAMPLEID*, *someinfo*, *etc*. must be separated by single underscores "\_", since PAPline only considers underscore separated parts of the filename for pairing.

## Add-on tools provided within PAPline

A few independent scripts are available within papline/tools folder. In the future similar scripts may be added to PAPline.

#### PCAplot.r

This script eases PCA plotting. User have to provide the *evec* file obtained from Eigensoft's `smartpca`, background population and selected population *csv* files. Each file have to be logically linked within the script. *Evec* file must remain untouched, while through the *csv* files the user can manipulate the visualisation of the PCA. The two *csv* files' structure is the same, background shall contain populations that the user want to use as background populations on the plot, while selected population file contains the samples or groups/populations to be highlighted. Given this *evec* file:

``` {.console}
           #eigvals:     7.893     3.939     2.438     1.871 
               I1836     0.0014      0.0042     -0.0001     -0.0007        Iberia_BA
               I1838     0.0013      0.0065     -0.0001     -0.0013         Iberia_C
               I1840     0.0024      0.0038      0.0001      0.0004        Iberia_BA
               I1843     0.0020      0.0063     -0.0000     -0.0006         Iberia_C
               I1851     0.0031     -0.0030      0.0002     -0.0007  Russia_MLBA_Krasnoyarsk
               I1852     0.0032     -0.0023      0.0005     -0.0007  Russia_MLBA_Krasnoyarsk
               I1853     0.0034     -0.0028      0.0002      0.0015  Russia_MLBA_Krasnoyarsk
               I1856     0.0033     -0.0026      0.0001     -0.0002  Russia_MLBA_Krasnoyarsk
               I1887    -0.0025      0.0056      0.0000     -0.0016  Hungary_MN_Vinca
               I1888    -0.0011      0.0010     -0.0006     -0.0000  Hungary_Medieval
               I1889    -0.0025      0.0058     -0.0004     -0.0009  Hungary_MN_Vinca
               I1890    -0.0008      0.0046     -0.0003      0.0006  Hungary_LN_Sopot
               I1891    -0.0013      0.0052      0.0000     -0.0000  Hungary_LN_Sopot
               I1892    -0.0017      0.0028     -0.0004     -0.0000  Hungary_AvarPeriod_German
               I1894    -0.0039      0.0051     -0.0004     -0.0003  Hungary_MN_Vinca
               I1896    -0.0025      0.0058     -0.0003     -0.0005  Hungary_MN_Vinca
               I1899    -0.0018      0.0053     -0.0001     -0.0007  Hungary_LN_Lengyel
               I1900    -0.0021      0.0057     -0.0003      0.0003  Hungary_LN_Lengyel
               I1901    -0.0016      0.0051     -0.0001     -0.0003  Hungary_LN_Lengyel
```

The *csv* file should look like this, if we want to highlight all groups, but *Hungary_AvarPeriod_German*, and also if we want to merge all Hungarian Neolithic samples:

+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+
| pca_pop                 | name_pop | col_pop       | fill_pop   | shape_pop | stroke_pop | size_pop | label_pop     | label2 |
+=========================+==========+===============+============+===========+============+==========+===============+========+
| Iberia_BA               | a        | deepskyblue   | black      | 1         | 0.7        | 3        | Ibérian       |        |
+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+
| Iberia_C                | b        | darkslategray | black      | 7         | 0.3        | 3        | español       |        |
+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+
| Russia_MLBA_Krasnoyarsk | c        | olivedrab3    | black      | 12        | 0.4        | 3        | Россия        |        |
+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+
| Hungary_MN_Vinca        | d        | indianred     | black      | 16        | 0.5        | 4        | Őskori magyar | group1 |
+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+
| Hungary_LN_Sopot        | d        | indianred     | black      | 16        | 0.5        | 4        | Őskori magyar | group2 |
+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+
| Hungary_LN_Lengyel      | d        | indianred     | black      | 16        | 0.5        | 4        | Őskori magyar | group3 |
+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+
| Hungary_Medieval        | e        | black         | firebrick3 | 21        | 0.5        | 3        | Medieval_hun  |        |
+-------------------------+----------+---------------+------------+-----------+------------+----------+---------------+--------+

The header names must remain intact, pca_pop have to be the group name within the *evec* file, name_pop reflects grouping and plotting order during visualisation, col_pop, fill_pop, shape_pop, stroke_pop, size_pop have to be filled logically, while label_pop can be filled with anything while many character types can be used, these names will appear in the legend of the plot. Label2 is yet under construction, it can be left as blank, or be filled with comments. Example files are provided within the folder.

### str.r

This script works with Y chromosome STR data, and it provides a subselection of samples depending on step distance. This tool is useful, when samples of interest are "lost" for the high number of samples and high complexity of the STR network. The user shall provide two *csv* files, one with the database data, and one with the sample(s) of interest, both having the exact same structure. The user can specify the maximum STR step distance, meaning that the script select the samples from the database *csv* that are within the given step distance of the provided sample *csv*, thus excluding database samples of too much step distance, i.e. getting rid of unnecessarily distant samples. At the end, the script saves all samples into a *ych* file, which is the standard input for the [Network](https://www.fluxus-engineering.com/nwpub.htm) software. Example for input *csv* is provided within the folder.

#### supervised_admix_source_selection.r

This script helps to create input files for supervised [Admixture](https://dalexander.github.io/admixture/download.html) analysis. It needs three input files, the *fam* file (for details, see `Admixture` description), an *ind* file (for details, see Eigensoft description), and a *csv* file, where the user specifies the source labels and populations. The *csv* file must **NOT** contain a header, the first column shall contain all selected **source** groups from *ind* file, the second an arbitrary grouping of these, see example file provided in directory. The script outputs the input for `Admixture` right away.
